\subsection{可変時間ステップおよび可変次数における後退差分法}
\label{Sec:BDF}
後退差分法（Backward Differentiation Formula, BDF）は，時間積分において，過去の値を用いて現在の値を求める方法である．BDFは，特に支配方程式の系が硬い問題において有効であり，数値的な安定性が高い特徴を持つ．7次以上は零点安定性がなくなるので考える必要はなく，6次までのBDFを考えることとする．
時間微分項 $\pdv{\vect{T}}/{t}$ を近似するため，いくつかの過去の時点 $(t_i, \vect{T}^i)$ を通るラグランジュ補間多項式 $P(t)$ を構築し，その現在時刻 $t_{n+1}$ での微分 $P'(t_{n+1})$ を用いる．
一般にLagrange補間多項式は，Lagrange基底関数 $l_i(x)$
\begin{align}
  l_i(x) = \prod_{\substack{j=0\leq j \leq i \\[0.2mm] j \neq i}}\frac{x - x_j}{x_i - x_j}
\end{align}
と補間対象となる変数$y_i$との線形結合として与えられる．
\begin{equation}
  \label{eq:bdf_lagrange}
  L\pab{x}\coloneq\sum_{i=0}^{j} y_i l_i \pab{x}
\end{equation}
計算を簡略化するため，局所的な時間座標 $\tau = t - t_{n+1}$ を導入する．この座標系では，現在時刻は $\tau=0$ となる．ただし，1次のBDFは単純な後退差分であるため，2次以上のBDFについて考える．本節では特に2次について詳述するとともに，6次までのBDFはそれまでと同様に導出できるため，その結果を示すだけとする．本章ではk-次数のBDFをBDF-kと表記する．

\subsubsection{BDF-2における導出}
3つの点 $(t_{n+1}, \vect{T}^{n+1})$，$(t_n, \vect{T}^n)$，$(t_{n-1}, \vect{T}^{n-1})$ を通る2次のラグランジュ補間多項式 $P(\tau)$ を考える．各点は局所座標で $(\tau_0, \vect{T}^{n+1}), (\tau_1, \vect{T}^n), (\tau_2, \vect{T}^{n-1})$ と表せる．
\begin{subequations}
  \label{eq:bdf2_lagrange_time}
  \begin{align}
    \tau_0 & = t_{n+1} - t_{n+1} = 0                              \\
    \tau_1 & = t_n - t_{n+1} = -\Delta t_n                        \\
    \tau_2 & = t_{n-1} - t_{n+1} = -(\Delta t_n + \Delta t_{n-1})
  \end{align}
\end{subequations}
ここで$P\pab{\tau}$が$k=2$の時のLagrange補間多項式であるとすると，\eqref{eq:bdf_lagrange}式より
\begin{align}
  P\pab{\tau} = \vect{T}^{n+1} l_0(\tau) + \vect{T}^n l_1(\tau) + \vect{T}^{n-1} l_2(\tau)
\end{align}
ここで，各基底関数は次のように定義される．
\begin{subequations}
  \label{eq:bdf2_lagrange_basis}
  \begin{align}
    l_0\pab{\tau} = \frac{\tau-\tau_1}{\tau_0-\tau_1} \frac{\tau-\tau_2}{\tau_0-\tau_2} \\[1mm]
    l_1\pab{\tau} = \frac{\tau-\tau_0}{\tau_1-\tau_0} \frac{\tau-\tau_2}{\tau_1-\tau_2} \\[1mm]
    l_2\pab{\tau} = \frac{\tau-\tau_0}{\tau_2-\tau_0} \frac{\tau-\tau_1}{\tau_2-\tau_1}
  \end{align}
\end{subequations}
ここで各基底関数の微分は\eqref{eq:bdf2_lagrange_basis}式より
\begin{subequations}
  \label{eq:bdf2_lagrange_basis_diff}
  \begin{align}
    l'_0\pab{\tau} & = \frac{\tau-\tau_2}{\pab{\tau_0-\tau_1}\pab{\tau_0-\tau_2}} + \frac{\tau-\tau_1}{\pab{\tau_0-\tau_1}\pab{\tau_0-\tau_2}} = \frac{2\tau - \tau_1 - \tau_2}{\pab{\tau_0-\tau_1}\pab{\tau_0-\tau_2}} \\[1mm]
    l'_1\pab{\tau} & = \frac{\tau-\tau_2}{\pab{\tau_1-\tau_0}\pab{\tau_1-\tau_2}} + \frac{\tau-\tau_0}{\pab{\tau_1-\tau_0}\pab{\tau_1-\tau_2}} = \frac{2\tau - \tau_0 - \tau_2}{\pab{\tau_1-\tau_0}\pab{\tau_1-\tau_2}} \\[1mm]
    l'_2\pab{\tau} & = \frac{\tau-\tau_1}{\pab{\tau_2-\tau_0}\pab{\tau_2-\tau_1}} + \frac{\tau-\tau_0}{\pab{\tau_2-\tau_0}\pab{\tau_2-\tau_1}} = \frac{2\tau - \tau_0 - \tau_1}{\pab{\tau_2-\tau_0}\pab{\tau_2-\tau_1}}
  \end{align}
\end{subequations}
$P\pab{\tau}$ の $\tau=0$ における微分は，
\begin{equation}
  P'\pab{0} = \vect{T}^{n+1}l'_0(0) + \vect{T}^n l'_1(0) + \vect{T}^{n-1}l'_2(0)
\end{equation}
これに\eqref{eq:bdf2_lagrange_basis_diff}および$\tau_1, \tau_2$ を代入し，時間ステップ比 $\rho_1 = \Delta t_n / \Delta t_{n-1}$ を用いて整理すると，
\begin{subequations}
  \begin{align}
    l'_0\pab{0} & = -\frac{\tau_1 + \tau_2}{\tau_1 \tau_2} = \frac{2\Delta t_n + \Delta t_{n-1}}{\Delta t_n \pab{\Delta t_n + \Delta t_{n-1}}} = \frac{2\rho_1 + 1}{\rho_1 + 1}\frac{1}{\Delta t_n} \\[2mm]
    l'_1\pab{0} & = -\frac{\tau_2}{\tau_1 \pab{\tau_1 - \tau_2}} = -\frac{\Delta t_n + \Delta t_{n-1}}{\Delta t_n \Delta t_{n-1}} = -\pab{\rho + 1}\frac{1}{\Delta t_n}                             \\[2mm]
    l'_2\pab{0} & = -\frac{\tau_1}{\tau_2 \pab{\tau_2 - \tau_1}} = \frac{\Delta t_n}{\pab{\Delta t_n + \Delta t_{n-1}}\Delta t_{n-1} } = \frac{\rho_1^2}{\rho_1 + 1}\frac{1}{\Delta t_n}
  \end{align}
\end{subequations}
よって，時間微分の近似式は，
\begin{equation}
  \label{eq:bdf2_approx}
  \pdv{\vect{T}}{t} \bigg|_{t_{n+1}} \approx \frac{1}{\Delta t_n} \bab{\frac{2\rho_1 + 1}{\rho_1 + 1}\vect{T}^{n+1} - \pab{\rho_1 + 1} \vect{T}^n + \frac{\rho_1^2}{\rho_1 + 1} \vect{T}^{n-1}}
\end{equation}

\subsubsection{BDF-$k$における導出結果}
BDF-$k$においては，$k$個の過去の時点を用いて微分を近似する．
一般に，時間ステップをくくりだすことで，$k$次のBDFは次のように定義される．
\begin{equation}
  \label{eq:bdf_k_approx}
  \pdv{\vect{T}}{t} \bigg|_{t_{n+1}} \approx \frac{1}{\Delta t_n} \sum_{i=0}^{k} l'_i\pab{0} \vect{T}^{n+1-i}
\end{equation}
ここで，$l_i$はBDF-$k$における係数であり，BDF-$k$の係数はCode Snippet\ref{prog:bdf_coeffs_final}を用いて求めることができる．
% ここで，$l_i$はBDF-kにおける係数であり，BDF-kの係数は次のように与えられる．ただし，$\rho_i=\Delta t_{n+1-i} / \Delta t_{n-i}$とする．ここで式を簡略化するために，$\displaystyle r_{ki}\coloneq\prod_{j=k}^{i} \rho_j$と定義する．
% \begin{itemize}
%   \item $k=3$のとき
%         \begin{subequations}
%           \begin{align}
%             l'_0\pab{0} & = \frac{3 r_{12} \rho_2 + 4 r_{12} + 2 \rho_1 + \rho_2 + 1}{\pab{\rho_1 + 1}\pab{r_{12} + \rho_2 + 1}} \\[2mm]
%             l'_1\pab{0} & = -\frac{\pab{\rho_1 + 1}\pab{r_{12} + \rho_2 + 1}}{\rho_2 + 1}                                        \\[2mm]
%             l'_2\pab{0} & = \frac{\rho_1^2 \pab{r_{12} + \rho_2 + 1}}{\rho_1 + 1}                                                \\[2mm]
%             l'_3\pab{0} & = -\frac{r_{12}^2 \rho_2\pab{\rho_1 + 1}}{\pab{\rho_2 + 1}\pab{r_{12} + \rho_2 + 1}}
%           \end{align}
%         \end{subequations}
%   \item $k=4$のとき
%         \begin{subequations}
%           \begin{align}
%             l'_0(0) & = \frac{1}{(\rho_1 + 1)(r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)}\notag                                             \\[1mm]
%                     & \quad \bigl(4 \rho_1 r_{12} r_{13} + 9 r_{12} r_{13} + 6 \rho_1 r_{13} + 3 \rho_1 r_{12} + 6 \rho_2 r_{13} + 8 r_{13}  \notag \\[1mm]
%                     & \quad　+ 4 r_{12} + 2 r_{31}  + \rho_2 r_{23} + 2 \rho_{23} + 2 \rho_1 + \rho_2 + \rho_3 + 1\bigr)                             \\[2mm]
%             l'_1(0) & = -\frac{
%               (\rho_1 + 1)(r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)
%             }{
%               (\rho_2 + r_{23} + \rho_3 + 1)
%             }                                                                                                                                       \\[2mm]
%             l'_2(0) & = \frac{
%               \rho_1^2 (r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)
%             }{
%               (\rho_1 + 1)(\rho_3 + 1)
%             }                                                                                                                                       \\[2mm]
%             l'_3(0) & = -\frac{
%               \rho_2 r_{12}^2 (\rho_1 + 1)(r_{13} + r_{23} + \rho_3 + 1)
%             }{
%               (\rho_2 + 1)(r_{12} + \rho_2 + 1)
%             }                                                                                                                                       \\[2mm]
%             l'_4(0) & = \frac{
%               \rho_3 r_{13}^2 r_{23} (\rho_1 + 1)(r_{12} + \rho_2 + 1)
%             }{
%               (\rho_3 + r_{23} + \rho_3 + 1)(r_{13} + r_{23} + \rho_3 + 1)
%             }
%           \end{align}
%         \end{subequations}
%   \item $k=5$のとき
%         \begin{subequations}
%           \begin{align}
%             l'_0(0) & = \frac{1}{
%               \pab{\rho_1 + 1}
%               \pab{r_{12} + \rho_2 + 1}
%               \pab{r_{13} + r_{23} + \rho_3 + 1}
%               \pab{r_{14} + r_{24} + r_{34} + \rho_4 + 1}}
%             \notag                                                                                                                      \\
%                     & \quad \bigl(
%             5 \rho_1 r_{14} r_{13} r_{12}
%             + 16 r_{14} r_{13} r_{12}
%             + 12 \rho_1 r_{13} r_{12}
%             + 8 \rho_1 r_{14} r_{12}
%             + 4 \rho_1 r_{13} r_{12}
%             \notag                                                                                                                      \\
%                     & \quad
%             + 18 \rho_2 r_{14} r_{13}
%             + 27 r_{14} r_{13}
%             + 18 r_{14} r_{12}
%             + 9 r_{13} r_{12}
%             + 9 \rho_1 \rho_3 r_{14}
%             + 12 \rho_1 r_{14}
%             + 6 \rho_1 r_{13}
%             \notag                                                                                                                      \\
%                     & \quad
%             + 3 \rho_1 r_{42}
%             + 3 \rho_1 r_{12}
%             + 8 \rho_2 r_{14} r_{23}
%             + 18 r_{14} r_{23}
%             + 12 \rho_2 r_{14}
%             + 6 \rho_2 r_{13}
%             + 12 \rho_3 r_{14}
%             \notag                                                                                                                      \\
%                     & \quad
%             + 16 r_{14}
%             + 8 r_{13}
%             + 4 r_{42}
%             + 4 r_{12}
%             + 2 \rho_1 \rho_3 r_{34}
%             + 4 \rho_1 r_{34}
%             + 2 \rho_1 \rho_3
%             + 2 r_{41}
%             + 2 \rho_1
%             \notag                                                                                                                      \\
%                     & \quad
%             + \rho_2 r_{24} r_{34}
%             + 3 r_{24} r_{34}
%             + 2 \rho_2 r_{24}
%             + \rho_2 r_{23}
%             + 3 \rho_3 r_{24}
%             + 4 r_{24}
%             + 2 r_{23}
%             + \rho_2 \rho_4
%             + \rho_2
%             \notag                                                                                                                      \\
%                     & \quad
%             + \rho_3 r_{34}
%             + 2 r_{34}
%             + \rho_3
%             + \rho_4
%             + 1
%             \bigr)
%             \\[2mm]
%             %
%             l'_1(0) & = -\frac{(\rho_1 + 1)(r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)(r_{14} + r_{24} + r_{34} + \rho_4 + 1)}{
%               (\rho_2 + 1)(r_{23} + \rho_3 + 1)(r_{24} + r_{34} + \rho_4 + 1)}
%             \\[2mm]
%             %
%             l'_2(0) & = \frac{\rho_1^2 (r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)(r_{14} + r_{24} + r_{34} + \rho_4 + 1)}{
%               (\rho_1 + 1)(\rho_3 + 1)(r_{34} + \rho_4 + 1)}
%             \\[2mm]
%             %
%             l'_3(0) & = -\frac{r_{12}^2 \rho_2 (\rho_1 + 1)(r_{13} + r_{23} + \rho_3 + 1)(r_{14} + r_{24} + r_{34} + \rho_4 + 1)}{
%               (\rho_2 + 1)(\rho_4 + 1)(r_{12} + \rho_2 + 1)}
%             \\[2mm]
%             %
%             l'_4(0) & = \frac{r_{13}^2 r_{23} \rho_3 (\rho_1 + 1)(r_{12} + \rho_2 + 1)(r_{14} + r_{24} + r_{34} + \rho_4 + 1)}{
%               (\rho_3 + 1)(r_{23} + \rho_3 + 1)(r_{13} + r_{23} + \rho_3 + 1)}
%             \\[2mm]
%             %
%             l'_5(0) & = -\frac{r_{14}^2 r_{24} r_{34} \rho_4 (\rho_1 + 1)(r_{12} + \rho_2 + 1)(r_{13} + r_{23} + \rho_3 + 1)}{
%               (\rho_4 + 1)(r_{34} + \rho_4 + 1)(r_{24} + r_{34} + \rho_4 + 1)(r_{14} + r_{24} + r_{34} + \rho_4 + 1)}
%           \end{align}
%         \end{subequations}
%   \item $k=6$のとき
%         \begin{subequations}
%           \begin{align}
%             l'_0(0)   & = \frac{1}{
%               \pab{\rho_1 + 1}
%               \pab{r_{12} + \rho_2 + 1}
%               \pab{r_{13} + r_{23} + \rho_3 + 1}
%               \pab{r_{14} + r_{24} + r_{34} + \rho_4 + 1}
%               \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_5 + 1}}
%             \notag                                                                                                                                                                                                                  \\[2mm]
%                       & \quad \bigl(
%             6 \rho_{1} r_{15} r_{14} r_{13} r_{12}^{2}
%             + 25 r_{15} r_{14} r_{13} r_{12}
%             + 20 \rho_{1} r_{15} r_{14} r_{13}
%             + 15 \rho_{1} r_{15} r_{14} r_{12}
%             + 10 \rho_{1} r_{15} r_{13} r_{12} \notag                                                                                                                                                                               \\[1mm]
%                       & \quad + 5 \rho_{1} r_{14} r_{13} r_{12}
%             + 40 \rho_{2} r_{15} r_{14} r_{13}
%             + 64 r_{15} r_{14} r_{13}
%             + 48 r_{15} r_{14} r_{12}
%             + 32 r_{15} r_{13} r_{12}
%             + 16 r_{14} r_{13} r_{12} \notag                                                                                                                                                                                        \\[1mm]
%                       & \quad + 24 \rho_{1}  \rho_{3} r_{15} r_{14}
%             + 36 \rho_{1} r_{15} r_{14}
%             + 24 \rho_{1} r_{15} r_{13}
%             + 12 \rho_{1} r_{14} r_{13}
%             + 12 \rho_{4} r_{15} r_{12}
%             + 16 \rho_{1} r_{15} r_{12} \notag                                                                                                                                                                                      \\[1mm]
%                       & \quad + 8 \rho_{1} r_{14} r_{12}
%             + 4 \rho_{1} \rho_{5} r_{13} r_{12}
%             + 4 \rho_{1} r_{13} r_{12}
%             + 30 \rho_{2} r_{15} r_{14} r_{23}
%             + 72 r_{15} r_{14} r_{23}
%             + 54 \rho_{2} r_{15} r_{14} \notag                                                                                                                                                                                      \\[1mm]
%                       & \quad + 36 \rho_{2} r_{15} r_{13}
%             + 18 \rho_{2} r_{14} r_{13}
%             + 54 \rho_{3} r_{15} r_{14}
%             + 81 r_{15} r_{14}
%             + 54 r_{15} r_{13}
%             + 27 r_{14} r_{13}
%             + 27 \rho_{4} r_{15} r_{12} \notag                                                                                                                                                                                      \\[1mm]
%                       & \quad + 36 r_{15} r_{12}
%             + 18 r_{14} r_{12}
%             + 9 r_{53} r_{12}
%             + 9 r_{13} r_{12}
%             + 12 \rho_{1} \rho_{3} r_{15} r_{34}
%             + 27 \rho_{1} r_{15} r_{34}
%             + 18 \rho_{1} \rho_{3} r_{15} \notag                                                                                                                                                                                    \\[1mm]
%                       & \quad + 9 \rho_{1} \rho_{3} r_{14}
%             + 18 \rho_{1} \rho_{4} r_{15}
%             + 24 \rho_{1} r_{15}
%             + 12 \rho_{1} r_{14}
%             + 6 \rho_{1} \rho_{5} r_{13}
%             + 6 \rho_{1} r_{13}
%             + 3 \rho_{1} \rho_{4} r_{42}
%             + 6 \rho_{1} r_{42} \notag                                                                                                                                                                                              \\[1mm]
%                       & \quad + 3 \rho_{1}\rho_{4} r_{12}
%             + 3 \rho_{1} r_{52}
%             + 3 \rho_{1} r_{12}
%             + 10 \rho_{2} r_{15} r_{24} r_{23}
%             + 32 r_{15} r_{24} r_{23}
%             + 24 \rho_{2} r_{15} r_{24}
%             + 16 \rho_{2} r_{15} r_{23} \notag                                                                                                                                                                                      \\[1mm]
%                       & \quad + 8 \rho_{2} r_{14} r_{23}
%             + 36 \rho_{3} r_{15} r_{24}
%             + 54 r_{15} r_{24}
%             + 36 r_{15} r_{23}
%             + 18 r_{14} r_{23}
%             + 18 \rho_{2} \rho_{4} r_{15} r_{24}
%             + 24 \rho_{2} r_{15}  \notag                                                                                                                                                                                            \\[1mm]
%                       & \quad + 12 \rho_{2} r_{14}
%             + 6 \rho_{2} r_{53}
%             + 6 \rho_{2} r_{13}
%             + 16 \rho_{3} r_{15} r_{34}
%             + 36 r_{15} r_{34}
%             + 24 \rho_{3} r_{15}
%             + 12 \rho_{3} r_{14}
%             + 24 \rho_{4} r_{15} \notag                                                                                                                                                                                             \\[1mm]
%                       & \quad + 32 r_{15}
%             + 16 r_{14}
%             + 8 r_{53}
%             + 8 r_{13}
%             + 4 \rho_{4} r_{42}
%             + 8 r_{42}
%             + 4 \rho_{4} r_{12}
%             + 4 r_{52}
%             + 4 r_{12}
%             + 2 \rho_{3} r_{31} r_{34} \notag                                                                                                                                                                                       \\[1mm]
%                       & \quad + 6 r_{31} r_{34}
%             + 4 \rho_{3} r_{31}
%             + 2 \rho_{1} \rho_{3} r_{34}
%             + 6 \rho_{4} r_{31}
%             + 8 r_{31}
%             + 4 \rho_{1} r_{34}
%             + 2 \rho_{1} \rho_{3} \rho_{5}
%             + 2 \rho_{1} \rho_{3}
%             + 2 \rho_{4} r_{41} \notag                                                                                                                                                                                              \\[1mm]
%                       & \quad + 4 \rho_{1} r_{45}
%             + 2 \rho_{1} \rho_{4}
%             + 2 \rho_{1} \rho_{5}
%             + 2 \rho_{1}
%             + \rho_{2} \rho_{4} r_{23}^3 r_{45}
%             + 4 \rho_{4} r_{23}^3 r_{45}
%             + 3 \rho_{2} \rho_{4} r_{23}^2 r_{45}
%             + 2 \rho_{2} r_{23}^2 r_{45}  \notag                                                                                                                                                                                    \\[1mm]
%                       & \quad + \rho_{2} r_{24} r_{23}
%             + 6 \rho_{3} r_{25} r_{24}
%             + 9 r_{25} r_{24}
%             + 6 r_{25} r_{23}
%             + 3 r_{24} r_{23}
%             + 3 \rho_{2} \rho_{4} r_{25}
%             + 4 \rho_{2} r_{25}
%             + 2 \rho_{2} r_{24} \notag                                                                                                                                                                                              \\[1mm]
%                       & \quad + \rho_{2} \rho_{5} r_{23}
%             + \rho_{2} r_{23}
%             + 4 \rho_{3} r_{25} r_{34}
%             + 9 r_{25} r_{34}
%             + 6 \rho_{3} r_{25}
%             + 3 \rho_{3} r_{24}
%             + 6 \rho_{4} r_{25}
%             + 8  r_{25}
%             + 4  r_{24}  \notag                                                                                                                                                                                                     \\[1mm]
%                       & \quad + 2 \rho_{5} r_{23}
%             + 2 r_{23}
%             + \rho_{4} r_{45}
%             + 2 \rho_{2} r_{45}
%             + \rho_{2} \rho_{4}
%             + \rho_{2} \rho_{5}
%             + \rho_{2}
%             + \rho_{3} r_{35} r_{34}
%             + 3 r_{35} r_{34}
%             + 2 \rho_{3} r_{35} \notag                                                                                                                                                                                              \\[1mm]
%                       & \quad + \rho_{3} r_{34}
%             + 3 \rho_{4} r_{35}
%             + 4 r_{35}
%             + 2 r_{34}
%             + \rho_{3} \rho_{5}
%             + \rho_{3}
%             + \rho_{4} r_{45}
%             + 2 r_{45}
%             + \rho_{4}
%             + \rho_{5}
%             + 1
%             \bigr)                                                                                                                                                                                                                  \\[2mm]
%             l'_{1}(0) & = - \frac{1}{\pab{\rho_{2} + 1} \pab{r_{23} + \rho_{3} + 1} \pab{r_{24} + r_{34} + \rho_{4} + 1} \pab{r_{25} + r_{35} + r_{45} + \rho_{5} + 1}} \notag                                                      \\[1mm]
%                       & \qquad \pab{\rho_{1} + 1} \pab{r_{12} + \rho_{2} + 1}
%             \pab{r_{13} + r_{23} + \rho_{3} + 1} \notag                                                                                                                                                                             \\[1mm]
%                       & \qquad \pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}
%             \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}                                                                                                                                                                  \\[2mm]
%             l'_{2}(0) & = \frac{1}{\pab{\rho_{1} + 1} \pab{\rho_{3} + 1} \pab{r_{34} + \rho_{4} + 1} \pab{r_{35} + r_{45} + \rho_{5} + 1}} \notag                                                                                   \\[1mm]
%                       & \qquad \rho_{1}^{2} \pab{r_{12} + \rho_{2} + 1}
%             \pab{r_{13} + r_{23} + \rho_{3} + 1} \notag                                                                                                                                                                             \\[1mm]
%                       & \qquad \pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}
%             \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}                                                                                                                                                                  \\[2mm]
%             l'_{3}(0) & = - \frac{1}{\pab{\rho_{2} + 1} \pab{\rho_{4} + 1} \pab{\rho_{1} \rho_{2} + \rho_{2} + 1} \pab{r_{45} + \rho_{5} + 1}} \notag                                                                               \\[1mm]
%                       & \qquad r_{12}^{2} \rho_{2} \pab{\rho_{1} + 1}
%             \pab{\rho_{1} \rho_{2} \rho_{3} + \rho_{2} \rho_{3} + \rho_{3} + 1} \notag                                                                                                                                              \\[1mm]
%                       & \qquad\pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}
%             \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}                                                                                                                                                                  \\[2mm]
%             l'_{4}(0) & = \frac{1}{ \pab{\rho_{3} + 1} \pab{\rho_{5} + 1} \pab{\rho_{2} \rho_{3} + \rho_{3} + 1} \pab{\rho_{1} \rho_{2} \rho_{3} + \rho_{2} \rho_{3} + \rho_{3} + 1}} \notag                                        \\[1mm]
%                       & \qquad r_{13}^{2} r_{23} \rho_{3} \pab{\rho_{1} + 1}
%             \pab{\rho_{1} \rho_{2} + \rho_{2} + 1}\notag                                                                                                                                                                            \\[1mm]
%                       & \qquad  \pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}
%             \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}                                                                                                                                                                  \\[2mm]
%             l'_{5}(0) & = - \frac{1}{\pab{\rho_{4} + 1} \pab{r_{34} + \rho_{4} + 1} \pab{r_{24} + r_{34} + \rho_{4} + 1} \pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}} \notag                                                      \\[1mm]
%                       & \qquad r_{14}^{2} r_{24} r_{34} \rho_{4}\pab{\rho_{1} + 1}
%             \pab{\rho_{1} \rho_{2} + \rho_{2} + 1} \notag                                                                                                                                                                           \\[1mm]
%                       & \qquad \pab{\rho_{1} \rho_{2} \rho_{3} + \rho_{2} \rho_{3} + \rho_{3} + 1}\pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}                                                                            \\[2mm]
%             l'_{6}(0)
%                       & = \frac{1}{\pab{\rho_{5} + 1} \pab{r_{45} + \rho_{5} + 1} \pab{r_{35} + r_{45} + \rho_{5} + 1} \pab{r_{25} + r_{35} + r_{45} + \rho_{5} + 1} \pab{r_{15} + r_{25} + r_{35} + r_{45} + \rho_{5} + 1}} \notag \\[1mm]
%                       & \qquad r_{15}^{2} r_{25} r_{35} r_{45} \rho_{5}\pab{\rho_{1} + 1}
%             \pab{\rho_{1} \rho_{2} + \rho_{2} + 1}\notag                                                                                                                                                                            \\[1mm]
%                       & \qquad  \pab{\rho_{1} \rho_{2} \rho_{3} + \rho_{2} \rho_{3} + \rho_{3} + 1}
%             \pab{r_{14} + r_{24} + r_{34} + \rho_{4} + 1}
%           \end{align}

%         \end{subequations}
% \end{itemize}

% \subsubsection{BDF-kのプログラミングによる確認手法}

\begin{lstlisting}[caption=Back Differential Formula Coefficients, label=prog:bdf_coeffs_final]
import sympy
from IPython.display import display, Math

def display_bdf_coeffs(k_order):
    """
    指定された次数のBDF係数を導出し，LaTeX数式としてIPython環境で表示する．
    """
    print(f'--- BDF-{k_order} の係数 ---')

    # 1. LaTeX表示用のシンボルを定義
    dt_n_sym = sympy.Symbol(r'\Delta t_n', positive=True)
    dts = [dt_n_sym] + [
        sympy.Symbol(rf'\Delta t_{{n-{i}}}', positive=True) for i in range(1, k_order)
    ]
    rhos = [
        sympy.Symbol(rf'\rho_{{{i + 1}}}', positive=True) for i in range(k_order - 1)
    ]

    tau = sympy.Symbol(r'\tau')
    n_sym = sympy.Symbol('n')

    # 2. 補間点の座標を定義（k_order+1点）
    nodes = [0]
    for i in range(1, k_order + 1):
        nodes.append(-sum(dts[:i]))

    # 3. 各係数 l'_j(0) を計算
    for j in range(k_order + 1):
        num = 1
        den = 1
        for i in range(k_order + 1):
            if i != j:
                num *= tau - nodes[i]
                den *= nodes[j] - nodes[i]
        l_j = num / den

        l_j_prime = sympy.diff(l_j, tau)
        l_j_prime_at_0 = l_j_prime.subs(tau, 0)

        result_in_rho = l_j_prime_at_0
        if k_order > 1:
            subs_rules = {}
            rho_prod = 1
            for i in range(k_order - 1):
                rho_prod *= rhos[i]
                subs_rules[dts[i + 1]] = dts[0] / rho_prod
            result_in_rho = result_in_rho.subs(subs_rules)

        exponent_val = (n_sym + 1) - j
        if exponent_val == n_sym + 1:
            superscript = 'n+1'
        elif exponent_val == n_sym:
            superscript = 'n'
        else:
            superscript = f'n-{j - 1}'
        term_comment = rf'\quad \text{{(Coefficient for }} T^{{{superscript}}})'

        latex_str = sympy.latex(sympy.factor(result_in_rho))
        display(Math(rf"L'_{{{j}}}(0) = {latex_str} {term_comment}"))

if __name__ == '__main__':
    display_bdf_coeffs(6)
\end{lstlisting}
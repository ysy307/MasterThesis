%============================================================================================================
% MasterThesis main.tex
%============================================================================================================
% 概要:
%   修士論文の主ファイル（LuaLaTeX + luatexja を想定）
%   このファイルは各章を \input で読み込み、目次・図表・参考文献を出力します。
%============================================================================================================
\documentclass[a4paper,12pt]{ltjsarticle}
\usepackage{luatexja}
\usepackage{luatexja-fontspec}
\usepackage[lualatex]{luatexja-preset}
\usepackage{unicode-math}
%============================================================================================================
% 章・節見出しの設定
%============================================================================================================
\usepackage{titlesec}
\usepackage{titletoc}

% 欧文本文（Serif）
\setmainfont{TeX Gyre Termes}
% 和文本文（明朝）
\setmainjfont[
  UprightFont = SourceHanSerif-Regular.otf,
  BoldFont    = SourceHanSerif-Bold.otf
]{Source Han Serif}

% 和文明朝（個別指定用）
\newjfontfamily\jmincho[
  UprightFont = SourceHanSerif-Regular.otf,
  BoldFont    = SourceHanSerif-Bold.otf
]{Source Han Serif}

% 和文ゴシック（見出し用）
\newjfontfamily\jgothic[
  UprightFont = SourceHanSans-Regular.otf,
  BoldFont    = SourceHanSans-Medium.otf
]{Source Han Sans}

% 欧文見出しフォント（Serifのまま）
\newfontfamily\esectionfont[
  UprightFont = SourceHanSans-Regular.otf,
  BoldFont    = SourceHanSans-Medium.otf
]{Source Han Sans}

% 見出し用統合フォント
\newcommand{\headingfont}{\esectionfont\jgothic\bfseries}
\newcommand{\headingtocfont}{\esectionfont\jmincho}

%============================================================================================================
% part の設定
%============================================================================================================
\newcommand{\partlabel}{第\thepart 部}
\titleformat{\part}[block]
  {\headingfont\fontsize{40pt}{70pt}\selectfont\centering}
  {\partlabel}
  {0pt}
  {\\[1ex]}
\titlespacing*{\part}{0pt}{0.35\textheight}{40pt}
%============================================================================================================
% section 以下の設定
%============================================================================================================
\titleformat{\section}[block]
  {\headingfont\LARGE}
  {\thesection}{1em}{}
  [\titlerule]

\titleformat{\subsection}
  {\headingfont\Large}{\thesubsection}{1em}{}

\titleformat{\subsubsection}
  {\headingfont\large}{\thesubsubsection}{1em}{}

\titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\subsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\subsubsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
%============================================================================================================
% 目次設定
%============================================================================================================
\titlecontents{part}
  [0pt]
  {\addvspace{10pt}\headingfont}
  {\makebox[3em][l]{第\thecontentslabel 部\enspace}}
  {}
  {\hfill\contentspage}

\titlecontents{section}
  [1.5em]
  {\headingtocfont}
  {\makebox[3em][l]{\thecontentslabel\enspace}}
  {\hspace*{1.5em}}
  {\titlerule*[.5pc]{.}\contentspage}

\titlecontents{subsection}
  [3em]
  {\headingtocfont}
  {\makebox[4em][l]{\thecontentslabel\enspace}} 
  {\hspace*{3.8em}}
  {\titlerule*[.5pc]{.}\contentspage}

\titlecontents{subsubsection}
  [4.5em]
  {\headingtocfont}
  {\makebox[5em][l]{\thecontentslabel\enspace}}
  {\hspace*{7.0em}}
  {\titlerule*[.5pc]{.}\contentspage}

%============================================================================================================
% 章番号の設定
%============================================================================================================
\usepackage{secdot}
\sectiondot{subsection}
\renewcommand{\thepart}{\arabic{part}}
\renewcommand{\thesection}{\thepart.\arabic{section}}
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
\makeatletter
\@addtoreset{section}{part}
\makeatother
\setcounter{secnumdepth}{3}
%============================================================================================================
% マージン設定
%============================================================================================================
\usepackage[top=30truemm,bottom=30truemm,left=30truemm,right=20truemm]{geometry}
% 全角文字幅を基準にしたマージン設定
% 35字×40行
\setlength{\baselineskip}{22.35pt}
\ltjsetparameter{jacharrange={-2}}
\setlength{\zw}{12.95pt}

% 基本パッケージ
\usepackage{cancel}
%============================================================================================================
% URL・ハイパーリンク
%============================================================================================================
\usepackage{xurl}
\urlstyle{same}
\usepackage{hyperref}
\hypersetup{
  luatex,
  pdfencoding=auto,
	setpagesize=false,
	bookmarks=true,
	bookmarksdepth=tocdepth,
	bookmarksnumbered=true,
	colorlinks=true,
	linkcolor=black,
	citecolor=black,
	urlcolor=black,
	filecolor=black,
	pdftitle={地下水流存在下の地盤凍結過程の水分・熱の同時解析手法の確立に向けて},
	pdfsubject={Toward the Establishment of a Method for Simultaneous Analysis of Water and Heat in Ground Freezing Processes in the Presence of Groundwater Flow},
	pdfauthor={菊地 駿},
	pdfkeywords={土壌凍結, 地盤凍結, 地下水流, 水・熱移動, 数値解析}
}

%============================================================================================================
% Bibliography settings
%============================================================================================================
\usepackage[
  block=par,
  backend=biber,
  style=../ref/biblatex/jpa, 
  hyperref=true,        % ハイパーリンクを有効化
  natbib=true,          % 互換性を高める
  labeldateparts=true,  % 日付のリンク精度を上げる
  uniquename=full,
  uniquelist=true
]{biblatex}
\DeclareNameFormat{labelname}{%
  \ifhyperref
    {\bibhyperref{%
       \usebibmacro{labelname:doname}%
         {\namepartfamily}%
         {\namepartfamilyi}%
         {\namepartgiven}%
         {\namepartgiveni}%
         {\namepartprefix}%
         {\namepartprefixi}%
         {\namepartsuffix}%
         {\namepartsuffixi}}}
    {\usebibmacro{labelname:doname}%
       {\namepartfamily}%
       {\namepartfamilyi}%
       {\namepartgiven}%
       {\namepartgiveni}%
       {\namepartprefix}%
       {\namepartprefixi}%
       {\namepartsuffix}%
       {\namepartsuffixi}}%
}
\renewbibmacro*{cite:plabelyear+extradate}{%
  \ifhyperref
    {\bibhyperref{%
       \usebibmacro{cite:plabelyear+extradate:inner}}}
    {\usebibmacro{cite:plabelyear+extradate:inner}}%
}

% 元の処理を内部マクロとして定義（jpa.cbxの内容をラップ）
\newbibmacro*{cite:plabelyear+extradate:inner}{%
  \iffieldundef{year}{%
    \iffieldundef{pubstate}{\printlabeldateextra}%
    {\printfield{pubstate}}%
  }{%
    \ifthenelse{\boolean{japanese}}{%
      \iffieldundef{origyear}{}{%
        \printorigdate%
        \addspace}%
      \iffieldequalstr{relatedtype}{translationof}{%
        \entrydata*{\thefield{related}}{\printdateextra}%
        \addspace}{}%
      \ifnameundef{translator}{}{%
        \printnames{translator}%
        \iffieldundef{translatortype}{\printtext{訳}\space}%
        {\printfield{translatortype}\space}%
      }%
      \printlabeldateextra%
    }{%
      \iffieldundef{origyear}{}{\printorigdate\setunit*{\addslash}}%
      \iffieldequalstr{relatedtype}{translationof}{%
        \entrydata*{\thefield{related}}{\printlabeldateextra}%
        \setunit*{\addslash}%
      }{} %
      \printlabeldateextra%
    }%
  }%
}
\addbibresource{references.bib}

%============================================================================================================
% 画像設定
%============================================================================================================
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{placeins}

\graphicspath{{/workspace/Images/Master/}}
%============================================================================================================
% TikZ settings
%============================================================================================================
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usetikzlibrary{intersections,calc,arrows.meta,patterns,patterns.meta, decorations.markings}
%============================================================================================================
% Table settings
%============================================================================================================
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{multicol}
\usepackage{multirow}



%============================================================================================================
% Math settings
%============================================================================================================
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{physics2}
\usephysicsmodule{ab}
\usepackage{derivative}
\usepackage{ifthen}

\allowdisplaybreaks[4]
\numberwithin{equation}{section}
\usepackage{../ref/mymathdef}

% Chemical formulas
\usepackage[version=3]{mhchem}
%============================================================================================================
% Caption settings
%============================================================================================================
\usepackage{cleveref}
% 数式番号
\crefformat{equation}{#2(#1) 式#3}
\crefrangeformat{equation}{#3(#1)#4～#5(#2)#6 式}
\crefmultiformat{equation}
  {#2(#1) 式#3}
  {，#2(#1) 式#3}
  {，#2(#1) 式#3}
  {，#2(#1) 式#3}
\crefrangemultiformat{equation}
  {#3(#1)#4～#5(#2)#6 式}
  {，#3(#1)#4～#5(#2)#6 式}
  {，#3(#1)#4～#5(#2)#6 式}
  {，#3(#1)#4～#5(#2)#6 式}

% 図番号
\crefformat{figure}{#2Fig.~#1#3}
\crefrangeformat{figure}{#3Figs.~#1#4--#5#2#6}
\crefmultiformat{figure}
  {#2Figs.~#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{figure}
  {#3Figs.~#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}

% subfigure番号
\crefformat{subfigure}{#2Fig.~#1#3}
\crefrangeformat{subfigure}{#3Figs.~#1#4--#5#2#6}
\crefmultiformat{subfigure}
  {#2Figs.~#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{subfigure}
  {#3Figs.~#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}

% 表番号
\crefformat{table}{#2Table~#1#3}
\crefrangeformat{table}{#3Tables~#1#4--#5#2#6}
\crefmultiformat{table}
  {#2Tables~#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{table}
  {#3Tables~#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}

% part番号
\crefformat{part}{#2第#1部#3}
\crefrangeformat{part}{#3第#1部#4～#5第#2部#6}
\crefmultiformat{part}
  {#2第#1部#3}
  {，#2第#1部#3}
  {，#2第#1部#3}
  {，#2第#1部#3}
\crefrangemultiformat{part}
  {#3第#1部#4～#5第#2部#6}
  {，#3第#1部#4～#5第#2部#6}
  {，#3第#1部#4～#5第#2部#6}
  {，#3第#1部#4～#5第#2部#6}

% section番号
\crefformat{section}{#2#1 節#3}
\crefrangeformat{section}{#3#1 節#4～#5#2 節#6}
\crefmultiformat{section}
  {#2#1 節#3}
  {，#2#1 節#3}
  {，#2#1 節#3}
  {，#2#1 節#3}
\crefrangemultiformat{section}
  {#3#1 節#4～#5#2 節#6}
  {，#3#1 節#4～#5#2 節#6}
  {，#3#1 節#4～#5#2 節#6}
  {，#3#1 節#4～#5#2 節#6}

% subsection番号
\crefformat{subsection}{#2#1 小節#3}
\crefrangeformat{subsection}{#3#1 小節#4～#5#2 小節#6}
\crefmultiformat{subsection}
  {#2#1 小節#3}
  {，#2#1 小節#3}
  {，#2#1 小節#3}
  {，#2#1 小節#3}
\crefrangemultiformat{subsection}
  {#3#1 小節#4～#5#2 小節#6}
  {，#3#1 小節#4～#5#2 小節#6}
  {，#3#1 小節#4～#5#2 小節#6}
  {，#3#1 小節#4～#5#2 小節#6}

% subsubsection番号
\crefformat{subsubsection}{#2#1 小小節#3}
\crefrangeformat{subsubsection}{#3#1 小小節#4～#5#2 小小節#6}
\crefmultiformat{subsubsection}
  {#2#1 小小節#3}
  {，#2#1 小小節#3}
  {，#2#1 小小節#3}
  {，#2#1 小小節#3}
\crefrangemultiformat{subsubsection}
  {#3#1 小小節#4～#5#2 小小節#6}
  {，#3#1 小小節#4～#5#2 小小節#6}
  {，#3#1 小小節#4～#5#2 小小節#6}
  {，#3#1 小小節#4～#5#2 小小節#6}

\let\eqref\cref

\usepackage{caption}
\captionsetup{
	format=plain,
	justification=centering,
	labelformat=simple,
	labelsep=quad,
  font=normalsize
}
\captionsetup[figure]{name=Fig.,skip=2pt}
\captionsetup[table]{name=Table}
\captionsetup[lstlisting]{name=Code}

% --- 図表の間隔設定 ---
\setlength{\textfloatsep}{6pt plus 2pt minus 2pt} % ページ上下にある図と本文の間
\setlength{\intextsep}{6pt plus 2pt minus 2pt}    % [h]などで文中に置いた図の前後
\setlength{\floatsep}{6pt plus 2pt minus 2pt}     % 図と図の間
\setlength{\abovecaptionskip}{3pt}                % 図とキャプションの間
\setlength{\belowcaptionskip}{2pt}                % キャプションの下（本文との間）

\captionsetup[subfigure]{
  font=normalsize,
  labelfont=normalsize,
  labelformat=parens
}
\renewcommand{\thesubfigure}{\alph{subfigure}}

%============================================================================================================
% TOC Settings
%============================================================================================================
\usepackage{tocloft}

% =========================================
%  1. Title (TOC, LOF, LOT) Settings
% =========================================
\renewcommand{\cfttoctitlefont}{\LARGE\headingfont}
\renewcommand{\cftloftitlefont}{\LARGE\headingfont}
\renewcommand{\cftlottitlefont}{\LARGE\headingfont}

% =========================================
%  2. Figure List Settings
% =========================================
% Add "Fig." prefix
\renewcommand{\cftfigpresnum}{Fig.~}

% Set width (calculated with standard font size)
\settowidth{\cftfignumwidth}{Fig.~00\quad} 

% Font settings: all standard (\normalfont)
\renewcommand{\cftfigfont}{\normalfont}
\renewcommand{\cftfigpagefont}{\normalfont}


% =========================================
%  3. Table List Settings
% =========================================
\renewcommand{\cfttabpresnum}{Table~}

% Set width (calculated with standard font size)
\settowidth{\cfttabnumwidth}{Table~00\quad}

% Font settings: all standard (\normalfont)
\renewcommand{\cfttabfont}{\normalfont}
\renewcommand{\cfttabpagefont}{\normalfont}

% --- Part (部) ---
\renewcommand{\cftpartfont}{\large\headingfont}
\renewcommand{\cftpartpagefont}{\headingfont}
\addtolength{\cftpartnumwidth}{1.5em}

% --- Section (節・付録) ---
% 標準フォント(\normalfont)に戻す
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsecpagefont}{\normalfont}
\addtolength{\cftsecnumwidth}{3em}

% --- Subsection (小節) ---
% 標準フォント(\normalfont)に戻す
\renewcommand{\cftsubsecfont}{\normalfont}
\renewcommand{\cftsubsecpagefont}{\normalfont}
\addtolength{\cftsubsecnumwidth}{2em}

%============================================================================================================
% SI Unit Settings
%============================================================================================================
\usepackage{siunitx}
\sisetup{
  % --- リスト (qtylist) ---
  list-separator       = {，},
  list-final-separator = {，},
  list-pair-separator  = {，},
  list-units           = single,
  % --- 範囲 (qtyrange) ---
  range-phrase         = {〜},
  range-units          = repeat,
  % --- 積 (qtyproduct) ---
  product-units        = repeat
}
\let\originalunit\unit
\renewcommand{\unit}[2][]{\relax[\originalunit[#1]{#2}]}
%============================================================================================================
% Layout Settings
%============================================================================================================
\usepackage{balance}
\usepackage{indentfirst}

%============================================================================================================
% 箇条書き設定
%============================================================================================================
\usepackage{enumitem}
\setlist[itemize]{font=\esectionfont\jgothic\bfseries}
\setlist[enumerate]{font=\esectionfont\jgothic\bfseries}
\setlist[description]{font=\esectionfont\jgothic\bfseries}

\usepackage{../ref/mycolorbox}
%============================================================================================================
% Color Definitions
%============================================================================================================
\definecolor{soil}{HTML}{996600}
\definecolor{water}{HTML}{0033CC}
\definecolor{ice}{HTML}{CCFFFF}
\definecolor{air}{HTML}{93FFAB}
\definecolor{vsoil}{HTML}{FFC7AF}

\definecolor{graySoil}{gray}{0.80}
\definecolor{grayWater}{gray}{0.90}
\definecolor{grayIce}{gray}{0.97}

%============================================================================================================
% Appendix Settings
%============================================================================================================
\usepackage{appendix}
\renewcommand{\appendixname}{付録}
\renewcommand{\appendixtocname}{付録}
\renewcommand{\appendixpagename}{付録}

%============================================================================================================
% Code Snippet Settings
%============================================================================================================
\usepackage{listings}
% 参考先
% https://whitecat-student.hatenablog.com/entry/2016/09/05/180705
\lstset{
  language = Python,
  backgroundcolor={\color[gray]{.90}},
  breaklines = true,
  breakindent = 10pt,
  basicstyle = \ttfamily\footnotesize,
  commentstyle = {\itshape \color[cmyk]{1,0.4,1,0}},
  classoffset = 0,
  keywordstyle = {\bfseries \color[cmyk]{0,1,0,0}},
  stringstyle = {\ttfamily \color[rgb]{0,0,1}},
  frame = TBrl,
  framesep = 5pt,
  numbers = left,
  stepnumber = 1,
  numberstyle = \tiny,
  tabsize = 4,
  captionpos = t,
  showspaces = false, 
  showstringspaces = false,
}

%============================================================================================================
% Algorithm Settings
%============================================================================================================
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\algrenewcommand\algorithmicdo{}

\usepackage{lineno}
\newcommand*\patchAmsMathEnvironmentForLineno[1]{
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}
     {\linenomath\csname old#1\endcsname}
     {\csname oldend#1\endcsname\endlinenomath}}
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{
  \patchAmsMathEnvironmentForLineno{#1}
  \patchAmsMathEnvironmentForLineno{#1*}}
\AtBeginDocument{
\patchBothAmsMathEnvironmentsForLineno{equation}
\patchBothAmsMathEnvironmentsForLineno{align}
\patchBothAmsMathEnvironmentsForLineno{flalign}
\patchBothAmsMathEnvironmentsForLineno{alignat}
\patchBothAmsMathEnvironmentsForLineno{gather}
\patchBothAmsMathEnvironmentsForLineno{multline}
}
\linenumbers

%============================================================================================================
% Header/Footer Settings
%============================================================================================================
\usepackage{fancyhdr}
\renewcommand{\footnoterule}{%
  \kern -3pt
  \hrule width \columnwidth height 0.4pt
  \kern 2.6pt 
}
%============================================================================================================
\begin{document}
%============================================================================================================
% FRONT MATTER
%============================================================================================================
\include{00-FrontMatter/00-FrontMatter}

%============================================================================================================
% MAIN BODY
%============================================================================================================
\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhead[L]{\leftmark}
\renewcommand{\headrulewidth}{0.4pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[R]{\thepage}
  \renewcommand{\headrulewidth}{0pt}
}

% Introduction
\include{01-Introduction/00-Introduction}

% Methods
\include{02-Methods/00-Methods}

% Results
\include{03-Results/00-Results}

% Discussion
\include{04-Discussion/00-Discussion}

%============================================================================================================
% BACK MATTER
%============================================================================================================
% Appendix
\include{90-Appendix/00-Appendix}
% References
\include{99-BackMatter/00-BackMatter}
%============================================================================================================
\end{document}
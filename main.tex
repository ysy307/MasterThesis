%============================================================================================================
% MasterThesis main.tex
%============================================================================================================
% 概要:
%   修士論文の主ファイル（LuaLaTeX + luatexja を想定）
%   このファイルは各章を \input で読み込み、目次・図表・参考文献を出力します。
%============================================================================================================
\documentclass[a4paper,12pt]{ltjsarticle}
\usepackage{luatexja}
\usepackage{luatexja-fontspec}
\usepackage[lualatex]{luatexja-preset}
\usepackage{unicode-math}
%============================================================================================================
% 章・節見出しの設定
%============================================================================================================
\usepackage{titlesec}
\usepackage{titletoc}

% 欧文本文（Serif）
\setmainfont{TeX Gyre Termes}
% 和文本文（明朝）
\setmainjfont[
  UprightFont = SourceHanSerif-Regular.otf,
  BoldFont    = SourceHanSerif-Bold.otf
]{Source Han Serif}

% 和文明朝（個別指定用）
\newjfontfamily\jmincho[
  UprightFont = SourceHanSerif-Regular.otf,
  BoldFont    = SourceHanSerif-Bold.otf
]{Source Han Serif}

% 和文ゴシック（見出し用）
\newjfontfamily\jgothic[
  UprightFont = SourceHanSans-Regular.otf,
  BoldFont    = SourceHanSans-Medium.otf
]{Source Han Sans}

% 欧文見出しフォント（Serifのまま）
\newfontfamily\esectionfont[
  UprightFont = SourceHanSans-Regular.otf,
  BoldFont    = SourceHanSans-Medium.otf
]{Source Han Sans}

% 見出し用統合フォント
\newcommand{\headingfont}{\esectionfont\jgothic\bfseries}
\newcommand{\headingtocfont}{\esectionfont\jmincho}

%============================================================================================================
% part の設定
%============================================================================================================
\newcommand{\partlabel}{第\thepart 部}
\titleformat{\part}[block]
  {\headingfont\fontsize{40pt}{60pt}\selectfont\centering}
  {\partlabel}
  {0pt}
  {\\[1ex]}
\titlespacing*{\part}{0pt}{0.35\textheight}{40pt}
%============================================================================================================
% section 以下の設定
%============================================================================================================
\titleformat{\section}[block]
  {\headingfont\LARGE}
  {\thesection}{1em}{}
  [\titlerule]

\titleformat{\subsection}
  {\headingfont\Large}{\thesubsection}{1em}{}

\titleformat{\subsubsection}
  {\headingfont\large}{\thesubsubsection}{1em}{}

\titlespacing*{\section}{0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\subsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\subsubsection}{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
%============================================================================================================
% 目次設定
%============================================================================================================
\titlecontents{part}
  [0pt]
  {\addvspace{10pt}\headingfont}
  {\makebox[3em][l]{第\thecontentslabel 部\enspace}}
  {}
  {\hfill\contentspage}

\titlecontents{section}
  [1.5em]
  {\headingtocfont}
  {\makebox[3em][l]{\thecontentslabel\enspace}}
  {\hspace*{1.5em}}
  {\titlerule*[.5pc]{.}\contentspage}

\titlecontents{subsection}
  [3em]
  {\headingtocfont}
  {\makebox[4em][l]{\thecontentslabel\enspace}} 
  {\hspace*{3.8em}}
  {\titlerule*[.5pc]{.}\contentspage}

\titlecontents{subsubsection}
  [4.5em]
  {\headingtocfont}
  {\makebox[5em][l]{\thecontentslabel\enspace}}
  {\hspace*{7.0em}}
  {\titlerule*[.5pc]{.}\contentspage}

%============================================================================================================
% 章番号の設定
%============================================================================================================
\usepackage{secdot}
\sectiondot{subsection}
\renewcommand{\thepart}{\arabic{part}}
\renewcommand{\thesection}{\thepart.\arabic{section}}
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
\makeatletter
\@addtoreset{section}{part}
\makeatother
\setcounter{secnumdepth}{3}
%============================================================================================================
% マージン設定
%============================================================================================================
\usepackage[top=30truemm,bottom=30truemm,left=30truemm,right=20truemm]{geometry}
\setlength{\baselineskip}{22.35pt}
\ltjsetparameter{jacharrange={-2}}
\setlength{\zw}{12.95pt}

% 基本パッケージ
\usepackage{cancel}
%============================================================================================================
% 引用文献設定
%============================================================================================================
\usepackage[block=par,backend=biber,style=../ref/biblatex/jpa, hyperref=true]{biblatex}
\addbibresource{references.bib}
%============================================================================================================
% URL・ハイパーリンク
%============================================================================================================
\usepackage{xurl}
\urlstyle{same}
\usepackage{hyperref}
\hypersetup{
  luatex,
  pdfencoding=auto,
	setpagesize=false,
	bookmarks=true,
	bookmarksdepth=tocdepth,
	bookmarksnumbered=true,
	colorlinks=true,
	linkcolor=black,
	citecolor=black,
	urlcolor=black,
	filecolor=black,
	pdftitle={},
	pdfsubject={},
	pdfauthor={},
	pdfkeywords={}
}
%============================================================================================================
% 画像設定
%============================================================================================================
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{placeins}

\graphicspath{{/workspace/Images/Master/}}
%============================================================================================================
% TikZ設定
%============================================================================================================
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usetikzlibrary{intersections,calc,arrows.meta,patterns,patterns.meta}
%============================================================================================================
% 表設定
%============================================================================================================
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{multicol}
\usepackage{multirow}



%============================================================================================================
% 数学関係設定
%============================================================================================================
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{physics2}
\usephysicsmodule{ab}
\usepackage{derivative}
\usepackage{ifthen}

\allowdisplaybreaks[4]
\numberwithin{equation}{section}
\usepackage{../ref/mymathdef}

% 化学式
\usepackage[version=3]{mhchem}
%============================================================================================================
% キャプション設定
%============================================================================================================
\usepackage{cleveref}
% 数式番号
\crefformat{equation}{#2(#1)#3~式}
\crefrangeformat{equation}{#3(#1)#4～#5(#2)#6~式}
\crefmultiformat{equation}
  {#2(#1)#3~式}
  {，#2(#1)#3~式}
  {，#2(#1)#3~式}
  {，#2(#1)#3~式}
\crefrangemultiformat{equation}
  {#3(#1)#4～#5(#2)#6~式}
  {，#3(#1)#4～#5(#2)#6~式}
  {，#3(#1)#4～#5(#2)#6~式}
  {，#3(#1)#4～#5(#2)#6~式}

% 図・表番号
\crefformat{figure}{Fig.~#2#1#3}
\crefrangeformat{figure}{Figs.~#3#1#4--#5#2#6}
\crefmultiformat{figure}
  {Figs.~#2#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{figure}
  {Figs.~#3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}

% --- subfigure 用のフォーマットを追加 ---
\crefformat{subfigure}{Fig.~#2#1#3}
\crefrangeformat{subfigure}{Figs.~#3#1#4--#5#2#6}
\crefmultiformat{subfigure}
  {Figs.~#2#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{subfigure}
  {Figs.~#3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}

\crefformat{table}{Table~#2#1#3}
\crefrangeformat{table}{Tables~#3#1#4--#5#2#6}
\crefmultiformat{table}
  {Tables~#2#1#3}
  {, #2#1#3}
  {, #2#1#3}
  {, #2#1#3}
\crefrangemultiformat{table}
  {Tables~#3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
  {, #3#1#4--#5#2#6}
% セクション階層
\crefformat{part}{#2#1#3~部}
\crefrangeformat{part}{#3#1#4～#5#2#6~部}
\crefmultiformat{part}
  {#2#1#3~部}
  {，#2#1#3~部}
  {，#2#1#3~部}
  {，#2#1#3~部}
\crefrangemultiformat{part}
  {#3#1#4～#5#2#6~部}
  {，#3#1#4～#5#2#6~部}
  {，#3#1#4～#5#2#6~部}
  {，#3#1#4～#5#2#6~部}

\crefformat{section}{#2#1#3~節}
\crefrangeformat{section}{#3#1#4～#5#2#6~節}
\crefmultiformat{section}
  {#2#1#3~節}
  {，#2#1#3~節}
  {，#2#1#3~節}
  {，#2#1#3~節}
\crefrangemultiformat{section}
  {#3#1#4～#5#2#6~節}
  {，#3#1#4～#5#2#6~節}
  {，#3#1#4～#5#2#6~節}
  {，#3#1#4～#5#2#6~節}

\crefformat{subsection}{#2#1#3~小節}
\crefrangeformat{subsection}{#3#1#4～#5#2#6~小節}
\crefmultiformat{subsection}
  {#2#1#3~小節}
  {，#2#1#3~小節}
  {，#2#1#3~小節}
  {，#2#1#3~小節}
\crefrangemultiformat{subsection}
  {#3#1#4～#5#2#6~小節}
  {，#3#1#4～#5#2#6~小節}
  {，#3#1#4～#5#2#6~小節}
  {，#3#1#4～#5#2#6~小節}

\crefformat{subsubsection}{#2#1#3~小小節}
\crefrangeformat{subsubsection}{#3#1#4～#5#2#6~小小節}
\crefmultiformat{subsubsection}
  {#2#1#3~小小節}
  {，#2#1#3~小小節}
  {，#2#1#3~小小節}
  {，#2#1#3~小小節}
\crefrangemultiformat{subsubsection}
  {#3#1#4～#5#2#6~小小節}
  {，#3#1#4～#5#2#6~小小節}
  {，#3#1#4～#5#2#6~小小節}
  {，#3#1#4～#5#2#6~小小節}

\let\eqref\cref

\usepackage{caption}
\captionsetup{
	format=plain,
	justification=centering,
	labelformat=simple,
	labelsep=space
}
\captionsetup[figure]{name=Fig.}
\captionsetup[table]{name=Table}
\captionsetup[lstlisting]{name=Code}

\captionsetup[subfigure]{
  font=normalsize,
  labelfont=normalsize,
  labelformat=parens
}
\renewcommand{\thesubfigure}{\alph{subfigure}}

%============================================================================================================
% 目次設定
%============================================================================================================
\usepackage{tocloft}

% =========================================
%  1. タイトル（目次・図目次・表目次）の設定
% =========================================
\renewcommand{\cfttoctitlefont}{\LARGE\headingfont}
\renewcommand{\cftloftitlefont}{\LARGE\headingfont}
\renewcommand{\cftlottitlefont}{\LARGE\headingfont}

% =========================================
%  2. 図目次 (Figure) の設定
% =========================================
% 先頭に「Fig.」をつける
\renewcommand{\cftfigpresnum}{Fig.~}

% 幅の設定（標準フォントのサイズで計算）
\settowidth{\cftfignumwidth}{Fig.~00\quad} 

% フォント設定: 全て標準(\normalfont)
\renewcommand{\cftfigfont}{\normalfont}
\renewcommand{\cftfigpagefont}{\normalfont}


% =========================================
%  3. 表目次 (Table) の設定
% =========================================
\renewcommand{\cfttabpresnum}{Table~}

% 幅の設定
\settowidth{\cfttabnumwidth}{Table~00\quad}

% フォント設定: 全て標準(\normalfont)
\renewcommand{\cfttabfont}{\normalfont}
\renewcommand{\cfttabpagefont}{\normalfont}

% --- Part (部) ---
\renewcommand{\cftpartfont}{\large\headingfont}
\renewcommand{\cftpartpagefont}{\headingfont}
\addtolength{\cftpartnumwidth}{1.5em}

% --- Section (節・付録) ---
% 標準フォント(\normalfont)に戻す
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsecpagefont}{\normalfont}
\addtolength{\cftsecnumwidth}{3em}

% --- Subsection (小節) ---
% 標準フォント(\normalfont)に戻す
\renewcommand{\cftsubsecfont}{\normalfont}
\renewcommand{\cftsubsecpagefont}{\normalfont}
\addtolength{\cftsubsecnumwidth}{2em}
%============================================================================================================
% SI単位
%============================================================================================================
\usepackage{siunitx}
\sisetup{
  % --- リスト (qtylist) ---
  list-separator       = {，},
  list-final-separator = {，},
  list-pair-separator  = {，},
  list-units           = single,
  % --- 範囲 (qtyrange) ---
  range-phrase         = {〜},
  range-units          = repeat,
  % --- 積 (qtyproduct) ---
  product-units        = repeat
}
%============================================================================================================
% レイアウト
%============================================================================================================
\usepackage{balance}
\usepackage{indentfirst}

%============================================================================================================
% 箇条書き
%============================================================================================================
\usepackage{enumitem}
\setlist[itemize]{font=\esectionfont\jgothic\bfseries}
\setlist[enumerate]{font=\esectionfont\jgothic\bfseries}
\setlist[description]{font=\esectionfont\jgothic\bfseries}

\usepackage{../ref/mycolorbox}

% 色定義
\definecolor{soil}{HTML}{996600}
\definecolor{water}{HTML}{0033CC}
\definecolor{ice}{HTML}{CCFFFF}
\definecolor{air}{HTML}{93FFAB}
\definecolor{vsoil}{HTML}{FFC7AF}

\definecolor{graySoil}{gray}{0.80}  % 20%グレー (少し濃い)
\definecolor{grayWater}{gray}{0.90} % 10%グレー (薄い)
\definecolor{grayIce}{gray}{0.97}   % 3%グレー (ほぼ白)

% 付録
\usepackage{appendix}
\renewcommand{\appendixname}{付録}
\renewcommand{\appendixtocname}{付録}
\renewcommand{\appendixpagename}{付録}

%============================================================================================================
% コードスニペット設定
%============================================================================================================
\usepackage{listings}
% 参考先
% https://whitecat-student.hatenablog.com/entry/2016/09/05/180705
\lstset{
  language = Python,
  backgroundcolor={\color[gray]{.90}},
  breaklines = true,
  breakindent = 10pt,
  basicstyle = \ttfamily\footnotesize,
  commentstyle = {\itshape \color[cmyk]{1,0.4,1,0}},
  classoffset = 0,
  keywordstyle = {\bfseries \color[cmyk]{0,1,0,0}},
  stringstyle = {\ttfamily \color[rgb]{0,0,1}},
  frame = TBrl,
  framesep = 5pt,
  numbers = left,
  stepnumber = 1,
  numberstyle = \tiny,
  tabsize = 4,
  captionpos = t,
  showspaces = false, 
  showstringspaces = false,
}

%============================================================================================================
% アルゴリズム
%============================================================================================================
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\algrenewcommand\algorithmicdo{}



%============================================================================================================
% ヘッダー・フッタ設定
%============================================================================================================
\usepackage{fancyhdr}

%============================================================================================================
\begin{document}
%============================================================================================================
% FRONT MATTER
%============================================================================================================
\include{00-FrontMatter/00-FrontMatter}

%============================================================================================================
% MAIN BODY
%============================================================================================================
\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhead[L]{\leftmark}
\renewcommand{\headrulewidth}{0.4pt}
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[R]{\thepage}
  \renewcommand{\headrulewidth}{0pt}
}

% Introduction
\include{01-Introduction/00-Introduction}

% Methods
\include{02-Methods/00-Methods}

% Results
\include{03-Results/00-Results}

%============================================================================================================
% BACK MATTER
%============================================================================================================
% Appendix
\include{90-Appendix/00-Appendix}
% References
\include{99-BackMatter/00-BackMatter}
%============================================================================================================
\end{document}